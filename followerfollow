javascript:(async function(){try{const c=document.cookie.match(/scratchcsrftoken=([^;]+)/);if(!c){alert("ログイン済みタブで実行してください（CSRFが必要です）");return;}const csrftoken=decodeURIComponent(c[1]);const me=prompt("あなたのユーザー名を入力してください","");if(!me)return;const target=prompt("対象のユーザー名を入力してください（その人のフォロワーを取得します）","");if(!target)return;let intervalSec=parseFloat(prompt("フォロー間隔（秒）","5"));if(isNaN(intervalSec)||intervalSec<1)intervalSec=1;let panel=document.getElementById("autoFollowPanel");if(!panel){panel=document.createElement("div");panel.id="autoFollowPanel";Object.assign(panel.style,{position:"fixed",top:"8px",right:"8px",width:"360px",maxHeight:"60vh",overflow:"auto",background:"rgba(255,255,255,0.98)",border:"2px solid #333",zIndex:2147483647,fontSize:"13px",padding:"8px",boxShadow:"0 2px 8px rgba(0,0,0,0.2)"});const stopBtn=document.createElement("button");stopBtn.textContent="STOP";stopBtn.style.display="block";stopBtn.style.marginBottom="6px";stopBtn.onclick=()=>{window._autoFollowStop=true;appendLog("停止要求 受信","crimson")};panel.appendChild(stopBtn);const title=document.createElement("div");title.innerHTML=`<b>自分未フォローのみフォロー: ${target}</b>`;title.style.marginBottom="6px";panel.appendChild(title);const logDiv=document.createElement("div");logDiv.id="autoFollowLog";panel.appendChild(logDiv);document.body.appendChild(panel);}const logDiv=document.getElementById("autoFollowLog");function appendLog(msg,color){const d=document.createElement("div");d.textContent=msg;if(color)d.style.color=color;logDiv.appendChild(d);logDiv.scrollTop=logDiv.scrollHeight;}appendLog("開始: "+(new Date()).toLocaleTimeString(),"blue");appendLog("あなた: "+me+" / 対象: "+target+" / 間隔: "+intervalSec+"秒","blue");window._autoFollowStop=false;async function fetchAllFollowing(username){appendLog("自分の following を取得中…");const set=new Set();let off=0,lim=40;while(true){if(window._autoFollowStop)break;const url=`https://api.scratch.mit.edu/users/${encodeURIComponent(username)}/following?limit=${lim}&offset=${off}`;try{const r=await fetch(url,{credentials:"include"});if(!r.ok){appendLog("自フォロー取得HTTPエラー "+r.status,"orange");break;}const arr=await r.json();if(!arr||arr.length===0)break;for(const it of arr)if(it&&it.username)set.add(String(it.username).toLowerCase());off+=lim;appendLog("取得中… "+set.size+" 人");await new Promise(r=>setTimeout(r,120));}catch(e){appendLog("自フォロー取得例外: "+e,"orange");break;}}appendLog("既フォロー取得完了: "+set.size+" 人","green");return set;}async function fetchAllFollowers(username){appendLog(username+" のフォロワーを取得中…");const list=[];let off=0,lim=40;while(true){if(window._autoFollowStop)break;const url=`https://api.scratch.mit.edu/users/${encodeURIComponent(username)}/followers?limit=${lim}&offset=${off}`;try{const r=await fetch(url,{credentials:"include"});if(!r.ok){appendLog("フォロワー取得HTTPエラー "+r.status,"orange");break;}const arr=await r.json();if(!arr||arr.length===0)break;for(const it of arr)if(it&&it.username)list.push(it.username);off+=lim;appendLog("取得中… "+list.length+" 人");await new Promise(r=>setTimeout(r,120));}catch(e){appendLog("フォロワー取得例外: "+e,"orange");break;}}appendLog("フォロワー取得完了: "+list.length+" 人","green");return list;}const followingSet=await fetchAllFollowing(me);if(window._autoFollowStop){appendLog("処理中断（自フォロー取得時）","crimson");return;}const followers=await fetchAllFollowers(target);if(window._autoFollowStop){appendLog("処理中断（フォロワー取得時）","crimson");return;}if(!followers||followers.length===0){appendLog("対象のフォロワーが見つかりません","red");return;}appendLog("処理開始（対象フォロワー数: "+followers.length+"）","blue");const MAX_RETRY=6;function wait(ms){return new Promise(r=>setTimeout(r,ms));}function backoffSec(n){return Math.min(10,1*Math.pow(10,n));}for(let i=0;i<followers.length;i++){if(window._autoFollowStop){appendLog("処理停止（ユーザー）","crimson");break;}const user=followers[i];appendLog(`(${i+1}/${followers.length}) → ${user}`);const userLc=String(user).toLowerCase();if(followingSet.has(userLc)){appendLog("スキップ（既フォロー）: "+user,"gray");continue;}let tried=0;while(true){if(window._autoFollowStop){appendLog("処理停止（ユーザー: "+user+")","crimson");break;}try{const res=await fetch(`/site-api/users/followers/${encodeURIComponent(user)}/add/`,{method:"PUT",credentials:"include",headers:{"X-CSRFToken":csrftoken,"X-Requested-With":"XMLHttpRequest","Accept":"application/json"}});if(res.ok){appendLog("成功: "+user,"green");followingSet.add(userLc);break;}else if(res.status===429){tried++;if(tried>MAX_RETRY){appendLog("429 再試行上限、スキップ: "+user,"gray");break;}const w=backoffSec(tried);appendLog("429: レート制限。"+user+" を "+w+" 秒後に再試行 ("+tried+"/"+MAX_RETRY+")","crimson");await wait(w*1000);continue;}else if(res.status===400||res.status===403){appendLog("スキップ("+res.status+"): "+user,"gray");followingSet.add(userLc);break;}else{appendLog("失敗("+res.status+"): "+user,"orange");break;}}catch(e){tried++;appendLog("例外: "+user+" / "+e,"orange");if(tried>MAX_RETRY){appendLog("例外で再試行上限、スキップ: "+user,"gray");break;}const w=Math.min(60,5*tried);await wait(w*1000);continue;}}await wait(Math.max(1000,Math.floor(intervalSec*1000)));}appendLog("全処理終了","blue");}catch(e){alert("エラー: "+e);console.error(e);}})();
